import os
import subprocess
import platform
import threading
import sys
import json
from typing import List, Optional

# --- Configuration ---
ROOT_DIR = os.path.dirname(os.path.abspath(__file__))
SERVER_DIR = os.path.join(ROOT_DIR, 'server')
FRONTEND_DIR = ROOT_DIR # Assuming package.json is in the root

PYTHON_SERVER_SCRIPT_TXT = os.path.join(SERVER_DIR, 'server_py.txt')
PYTHON_SERVER_SCRIPT = os.path.join(SERVER_DIR, 'server.py')
NODE_AUTH_SERVER_SCRIPT_TXT = os.path.join(SERVER_DIR, 'auth_node.txt')
NODE_AUTH_SERVER_SCRIPT = os.path.join(SERVER_DIR, 'auth.js')
PACKAGE_JSON_TXT = os.path.join(SERVER_DIR, 'package_json.txt')
PACKAGE_JSON = os.path.join(ROOT_DIR, 'package.json')

# --- Helper Functions ---

def print_header(title: str):
    """Prints a styled header."""
    print("\n" + "=" * 50)
    print(f"üöÄ {title}")
    print("=" * 50)

def prepare_file(txt_path: str, final_path: str, name: str, is_move: bool = False):
    """Checks for a file and automatically renames/moves it from a .txt source if necessary."""
    if os.path.exists(final_path):
        return True

    if os.path.exists(txt_path):
        action = "moved" if is_move else "renamed"
        print(f"Info: '{os.path.basename(final_path)}' not found, but source '{os.path.relpath(txt_path, ROOT_DIR)}' exists.")
        try:
            os.rename(txt_path, final_path) # os.rename can move files across same filesystem
            print(f"Automatically {action} source to '{os.path.relpath(final_path, ROOT_DIR)}'.")
            return True
        except Exception as e:
            print(f"Error: Could not {action} file for {name}. Reason: {e}")
            return False
    else:
        print(f"Error: Required file for {name} not found.")
        print(f"Neither '{os.path.relpath(final_path, ROOT_DIR)}' nor '{os.path.relpath(txt_path, ROOT_DIR)}' could be found.")
        return False

def update_package_json_for_esm():
    """Ensures package.json has 'type: module' for ES module support."""
    if not os.path.exists(PACKAGE_JSON):
        return False # Should have been handled by prepare_file

    try:
        with open(PACKAGE_JSON, 'r+') as f:
            data = json.load(f)
            if data.get('type') != 'module':
                print("Info: 'package.json' is missing '\"type\": \"module\"', which is required for the Node.js server.")
                data['type'] = 'module'
                f.seek(0)
                json.dump(data, f, indent=2)
                f.truncate()
                print("Automatically added '\"type\": \"module\"' to package.json.")
    except (json.JSONDecodeError, IOError) as e:
        print(f"Error reading or updating package.json: {e}")
        return False
    
    return True

def run_command(command: List[str], working_dir: str, name: str, env: Optional[dict] = None):
    """Runs a command in a subprocess and streams its output."""
    print(f"[{name}] Starting process with command: {' '.join(command)}")
    print(f"[{name}] Working directory: {working_dir}")
    try:
        # Use a shell on Windows for npm/node commands if they aren't in path directly
        use_shell = platform.system() == 'Windows'

        process = subprocess.Popen(
            command,
            cwd=working_dir,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            encoding='utf-8',
            errors='replace',
            env=env,
            shell=use_shell
        )
        
        def stream_output(pipe, prefix):
            if pipe:
                for line in iter(pipe.readline, ''):
                    print(f"{prefix} {line}", end='')
        
        stdout_thread = threading.Thread(target=stream_output, args=(process.stdout, f"[{name}]"))
        stderr_thread = threading.Thread(target=stream_output, args=(process.stderr, f"[{name}-ERR]"))
        
        stdout_thread.start()
        stderr_thread.start()
        
        process.wait()
        
        stdout_thread.join()
        stderr_thread.join()

        print(f"[{name}] Process finished with exit code {process.returncode}.")

    except FileNotFoundError:
        print(f"[{name}-ERR] Command not found: {command[0]}. Is it installed and in your PATH?")
    except Exception as e:
        print(f"[{name}-ERR] An error occurred: {e}")

# --- Task Functions ---

def install_dependencies():
    """Installs both Python and Node.js dependencies."""
    print_header("Installing Dependencies")
    
    # Python dependencies
    print("\n--- Installing Python dependencies ---")
    pip_command = [sys.executable, '-m', 'pip', 'install', '-r', 'requirements.txt']
    run_command(pip_command, SERVER_DIR, "pip")
    
    # Node.js dependencies
    print("\n--- Installing Node.js dependencies ---")
    if not prepare_file(PACKAGE_JSON_TXT, PACKAGE_JSON, "package.json", is_move=True):
        print("[npm-ERR] Could not prepare package.json. Skipping npm install.")
        return
    
    npm_command = ['npm', 'install']
    run_command(npm_command, FRONTEND_DIR, "npm")

def run_python_server():
    """Runs the Python/Flask API server."""
    print_header("Running Python Flask Server")
    if not prepare_file(PYTHON_SERVER_SCRIPT_TXT, PYTHON_SERVER_SCRIPT, "Python server"):
        return
        
    env = os.environ.copy()
    env['PORT'] = '8080' # Set default port
    env['FLASK_APP'] = 'server.py'
    env['FLASK_ENV'] = 'development'
    
    command = [sys.executable, PYTHON_SERVER_SCRIPT]
    run_command(command, ROOT_DIR, "Python API", env)

def run_node_auth_server():
    """Runs the Node.js/Express authentication server."""
    print_header("Running Node.js Auth Server")
    if not prepare_file(NODE_AUTH_SERVER_SCRIPT_TXT, NODE_AUTH_SERVER_SCRIPT, "Node.js auth server") or \
       not prepare_file(PACKAGE_JSON_TXT, PACKAGE_JSON, "package.json", is_move=True) or \
       not update_package_json_for_esm():
        print("Could not prepare files for Node.js server. Aborting.")
        return

    env = os.environ.copy()
    env['PORT'] = '3001' # Set default port
    
    node_command = ['node', NODE_AUTH_SERVER_SCRIPT]
    run_command(node_command, ROOT_DIR, "Node Auth", env)

def run_frontend_dev_server():
    """Runs the frontend development server (e.g., Vite)."""
    print_header("Running Frontend Dev Server")
    if not os.path.exists(PACKAGE_JSON):
        print("[Vite-ERR] package.json not found. Cannot start frontend server. Try running 'Install Dependencies' first.")
        return
        
    npm_command = ['npm', 'run', 'dev']
    run_command(npm_command, FRONTEND_DIR, "Frontend")

def run_all_services():
    """Runs all services concurrently."""
    print_header("Starting All Services")

    # Prepare all files and configurations
    py_ready = prepare_file(PYTHON_SERVER_SCRIPT_TXT, PYTHON_SERVER_SCRIPT, "Python server")
    node_script_ready = prepare_file(NODE_AUTH_SERVER_SCRIPT_TXT, NODE_AUTH_SERVER_SCRIPT, "Node.js auth server")
    pkg_json_ready = prepare_file(PACKAGE_JSON_TXT, PACKAGE_JSON, "package.json", is_move=True)
    
    esm_config_ready = False
    if pkg_json_ready:
        esm_config_ready = update_package_json_for_esm()

    if not (py_ready and node_script_ready and pkg_json_ready and esm_config_ready):
        print("\nEnvironment is not ready. Aborting start of services. Run 'Check Environment' for details.")
        return

    # Prepare environments
    python_env = os.environ.copy()
    python_env['PORT'] = '8080'
    python_env['FLASK_APP'] = 'server.py'
    python_env['FLASK_ENV'] = 'development'

    node_env = os.environ.copy()
    node_env['PORT'] = '3001'
    
    # Prepare commands
    python_command = [sys.executable, PYTHON_SERVER_SCRIPT]
    node_command = ['node', NODE_AUTH_SERVER_SCRIPT]
    npm_command = ['npm', 'run', 'dev']
        
    # Create and start threads
    python_thread = threading.Thread(target=run_command, args=(python_command, ROOT_DIR, "Python API", python_env))
    node_thread = threading.Thread(target=run_command, args=(node_command, ROOT_DIR, "Node Auth", node_env))
    frontend_thread = threading.Thread(target=run_command, args=(npm_command, FRONTEND_DIR, "Frontend"))
    
    python_thread.start()
    node_thread.start()
    frontend_thread.start()
    
    try:
        python_thread.join()
        node_thread.join()
        frontend_thread.join()
    except KeyboardInterrupt:
        print("\nCaught KeyboardInterrupt, stopping services...")
        # Processes are daemonic and will be terminated when the main script exits.

def check_environment():
    """Checks for necessary files and configurations, preparing them automatically."""
    print_header("Checking and Preparing Environment")
    
    # Prepare files and capture success status
    py_ok = prepare_file(PYTHON_SERVER_SCRIPT_TXT, PYTHON_SERVER_SCRIPT, "Python server")
    node_ok = prepare_file(NODE_AUTH_SERVER_SCRIPT_TXT, NODE_AUTH_SERVER_SCRIPT, "Node.js auth server")
    pkg_json_ok = prepare_file(PACKAGE_JSON_TXT, PACKAGE_JSON, "package.json", is_move=True)
    
    esm_ok = False
    if pkg_json_ok:
        esm_ok = update_package_json_for_esm()

    # Report status based on preparation results
    print("\n--- Status Report ---")
    checks = {
        "Python Server Script": py_ok,
        "Node Auth Script": node_ok,
        "package.json in root": pkg_json_ok,
        "package.json ESM config": esm_ok,
        "Python Requirements": os.path.exists(os.path.join(SERVER_DIR, 'requirements.txt')),
        "Secrets .env file": os.path.exists(os.path.join(ROOT_DIR, 'secrets', '.env')),
    }
    
    all_ok = True
    for check, result in checks.items():
        status = "‚úÖ OK" if result else "‚ùå FAILED / MISSING"
        if not result:
            all_ok = False
        print(f"- {check}: {status}")
    
    if not checks["Secrets .env file"]:
        print("\nWarning: No 'secrets/.env' file found. The servers might not work correctly without environment variables.")
        print("Consider creating 'secrets/.env' from the '.env.example.txt' template.")
    
    if all_ok:
        print("\nEnvironment check and preparation successful!")
    else:
        print("\nSome environment checks or preparations failed. Please review the messages above.")


def main():
    """Main function to display the menu and handle user input."""
    menu_options = {
        '1': ('Install Dependencies', install_dependencies),
        '2': ('Run Python API Server', run_python_server),
        '3': ('Run Node.js Auth Server', run_node_auth_server),
        '4': ('Run Frontend Dev Server', run_frontend_dev_server),
        '5': ('Run All Services (Concurrent)', run_all_services),
        '6': ('Check Environment', check_environment),
        '7': ('Exit', None),
    }

    while True:
        print_header("Developer Task Runner")
        for key, (text, _) in menu_options.items():
            print(f"{key}. {text}")
        
        choice = input("Select an option: ").strip()
        
        if choice in menu_options:
            if choice == '7':
                print("Exiting...")
                break
            
            _, func = menu_options[choice]
            if func:
                try:
                    func()
                except KeyboardInterrupt:
                    print("\nOperation interrupted by user.")
        else:
            print("Invalid choice. Please try again.")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nTask runner stopped. Exiting.")
        sys.exit(0)
