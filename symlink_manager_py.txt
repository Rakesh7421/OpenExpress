import os
import sys
import platform
import subprocess
import shutil

def log(msg):
    """Prints a log message with a script identifier."""
    # NOTE: Removed unicode characters for Windows console compatibility.
    print(f"[{os.path.basename(__file__)}] {msg}")

def create_junction(target_path, link_path):
    """Creates a directory junction on Windows using the 'mklink /J' command."""
    log(f"Attempting to create junction from '{link_path}' to '{target_path}'")
    try:
        # 'mklink' is an internal command of cmd.exe. We must call it through 'cmd /c'.
        # The link path must not exist, but the target path must exist.
        subprocess.run(
            ['cmd', '/c', 'mklink', '/J', link_path, target_path],
            check=True,
            capture_output=True,
            text=True
        )
        log("Success: Junction created successfully.")
        return True
    except subprocess.CalledProcessError as e:
        log("Error: Failed to create junction using 'mklink /J'.")
        # Provide a cleaner error message from stderr.
        error_message = e.stderr.strip() if e.stderr else "Unknown error."
        log(f"   Details: {error_message}")
        log("   This can happen if the link path already exists as a file or if permissions are insufficient.")
        return False
    except FileNotFoundError:
        log("Error: 'cmd.exe' not found in system PATH. Cannot create a junction.")
        return False

def create_symlink_unix(target_path, link_path):
    """Creates a standard symbolic link on Unix-like systems (Linux, macOS)."""
    log(f"Attempting to create symlink from '{link_path}' to '{target_path}'")
    try:
        os.symlink(target_path, link_path)
        log("Success: Symlink created successfully.")
        return True
    except OSError as e:
        log(f"Error: Failed to create symlink: {e}")
        return False

def main(target_arg, link_arg):
    """Main execution logic for creating the directory link."""
    # Resolve to absolute paths to avoid ambiguity.
    target_path = os.path.abspath(target_arg)
    link_path = os.path.abspath(link_arg)
    link_parent_dir = os.path.dirname(link_path)

    log(f"-> Target: {target_path}")
    log(f"-> Link:   {link_path}")

    # Step 1: Ensure the necessary directories exist before creating a link.
    log("-> Ensuring directories exist...")
    try:
        os.makedirs(target_path, exist_ok=True)
        os.makedirs(link_parent_dir, exist_ok=True)
        log("   - Directories are ready.")
    except OSError as e:
        log(f"Error: Failed to create necessary directories: {e}")
        sys.exit(1)

    # Step 2: Clean up any pre-existing file, directory, or link at the target location.
    log(f"-> Checking for existing item at '{link_path}'...")
    try:
        if os.path.lexists(link_path):
            # First, check for standard symbolic links.
            if os.path.islink(link_path):
                os.remove(link_path)
                log("   - Removed existing symbolic link.")
            # On Windows, junctions are directories but not links. `os.rmdir` can remove them.
            elif platform.system() == "Windows" and os.path.isdir(link_path):
                try:
                    os.rmdir(link_path)
                    log("   - Removed existing directory junction.")
                except OSError:
                    # If rmdir fails, it's likely a real, populated directory. Use rmtree.
                    log("   - rmdir failed, falling back to shutil.rmtree for populated directory.")
                    shutil.rmtree(link_path)
                    log("   - Removed directory with shutil.rmtree.")
            # Standard directory removal for other OS.
            elif os.path.isdir(link_path):
                shutil.rmtree(link_path)
                log("   - Removed existing directory.")
            # Handle plain files.
            else:
                os.remove(link_path)
                log("   - Removed existing file.")
        else:
            log("   - Nothing to remove. Path is clean.")
    except OSError as e:
        log(f"Error: Failed to remove existing item at '{link_path}': {e}")
        sys.exit(1)

    # Step 3: Create the appropriate type of link for the operating system.
    log("-> Creating link...")
    success = False
    if platform.system() == "Windows":
        # Junctions are more reliable for directories on Windows and don't require special user permissions.
        success = create_junction(target_path, link_path)
    else:
        # Use standard symbolic links for all other systems.
        success = create_symlink_unix(target_path, link_path)

    if not success:
        log("Error: Link creation process failed.")
        sys.exit(1)

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Error: Invalid arguments.", file=sys.stderr)
        print("Usage: python symlink_manager_py.txt <target_directory> <link_path>", file=sys.stderr)
        sys.exit(1)
    
    main(sys.argv[1], sys.argv[2])