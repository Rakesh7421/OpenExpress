import os
import time
from functools import wraps
import jwt
from flask import Flask, request, jsonify
from flask_cors import CORS
from dotenv import load_dotenv
import google.generativeai as genai

# In Vercel, environment variables are managed in the project settings.
# This ensures that secrets are loaded securely.
# Note: The .env file is not uploaded to Vercel.
load_dotenv()

app = Flask(__name__)
CORS(app)

# Load secrets from environment variables.
JWT_SECRET = os.environ.get('JWT_SECRET', 'your-super-secret-jwt-key-here')
GEMINI_API_KEY = os.environ.get('GEMINI_API_KEY')

# Configure Gemini API only if the key is available.
# On Vercel, this check determines if the AI features are active.
if GEMINI_API_KEY:
    genai.configure(api_key=GEMINI_API_KEY)
else:
    # This print will appear in the Vercel function logs if the key is missing.
    print("WARNING: GEMINI_API_KEY environment variable is not set. AI features will be disabled.")


# --- Authentication Decorator ---
def token_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        token = None
        if 'authorization' in request.headers:
            # Expecting 'Bearer <token>'
            token = request.headers['authorization'].split(' ')[1]
        
        if not token:
            return jsonify({'error': 'Token is missing!'}), 401
        
        try:
            # Decode the token using the secret key
            data = jwt.decode(token, JWT_SECRET, algorithms=['HS256'])
            current_user = data['id']
        except jwt.ExpiredSignatureError:
            return jsonify({'error': 'Token has expired!'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'error': 'Token is invalid!'}), 401
        
        # Pass the user identifier to the decorated function
        return f(current_user, *args, **kwargs)
    return decorated


# --- API Routes ---
@app.route('/')
@app.route('/api/status')
def index():
  """Root endpoint to confirm the serverless function is running."""
  return jsonify(message='OpenExpress Python serverless function is running!')

@app.route('/api/ai-suggestions', methods=['POST'])
def get_ai_suggestions():
    """Endpoint to get design suggestions from the Gemini API."""
    # Vercel will not run this part of the code if the key is not set,
    # because the app will fail to initialize the genai module.
    # However, this check is good for robustness.
    if not GEMINI_API_KEY:
        return jsonify({
            'error': 'The AI service is not configured on the server; API key is missing.'
        }), 503

    data = request.get_json()
    if not data or 'prompt' not in data:
        return jsonify({'error': 'A "prompt" is required in the request body.'}), 400
    
    user_prompt = data['prompt']

    try:
        # Use a recommended model for this kind of task.
        model = genai.GenerativeModel('gemini-2.5-flash')
        
        full_prompt = f"""
          You are an expert UI/UX and graphic designer.
          A user is asking for design suggestions for the following concept: "{user_prompt}".

          Please provide 3 distinct and creative design ideas. For each idea, suggest:
          1.  A concept or theme.
          2.  A color palette (with hex codes).
          3.  Font pairings (one for headings, one for body).
          4.  A brief layout description.

          Format your response clearly.
        """
        
        response = model.generate_content(full_prompt)
        
        # Return the generated text directly.
        return jsonify({'suggestions': response.text})

    except Exception as e:
        # Log the error for debugging on Vercel.
        print(f"Error calling Gemini API: {e}")
        return jsonify({'error': f'Failed to get suggestions from the AI model.'}), 500

@app.route('/api/save-design', methods=['POST'])
@token_required
def save_design(current_user):
  """Endpoint to receive and process design data from the frontend."""
  print(f'Received design data from user {current_user} to save:', request.json)

  if not request.json or 'title' not in request.json:
    return jsonify(error='Design title is required.'), 400
  
  # Simulate saving to a database.
  return jsonify(
    message='Design saved successfully!', 
    designId=f'dsn_{int(time.time())}',
    dataReceived=request.json 
  ), 201

@app.route('/api/schedule-post', methods=['POST'])
@token_required
def schedule_post(current_user):
    """Endpoint to schedule a content post."""
    data = request.get_json()
    print(f"Received post schedule request from user {current_user}:", data)

    if not all(key in data for key in ['brand', 'platform', 'content']):
        return jsonify(error='Missing required fields for scheduling.'), 400
    
    print(f"Scheduling post for {data['brand']} on {data['platform']}.")

    return jsonify(message=f"Post for {data['brand']} on {data['platform']} has been scheduled!"), 201


@app.route('/api/image-upload', methods=['POST'])
def upload_image():
  """Endpoint to handle image uploads."""
  if 'image_file' not in request.files:
    return jsonify(error='No image file provided.'), 400
  
  file = request.files['image_file']
  
  if file.filename == '':
    return jsonify(error='No selected file.'), 400

  if file:
    # In Vercel, files can be temporarily stored in the /tmp directory.
    print(f"Received image file: {file.filename}")
    print(f"Simulating save for {file.filename}...")
    
    return jsonify(
        message='Image uploaded successfully!',
        imageUrl=f'https://fake-cdn.com/images/{file.filename}'
    ), 200

# Vercel does not use the __main__ block. It imports the 'app' object directly.
# This block is only for local testing if you were to run this file directly.
if __name__ == '__main__':
  port = int(os.environ.get('PORT', 8080))
  app.run(host='0.0.0.0', port=port, debug=True)