import os
import time
from flask import Flask, request, jsonify
from flask_cors import CORS

# A functional Flask server for the OpenExpress app.
app = Flask(__name__)

# Middleware
# Enable Cross-Origin Resource Sharing (CORS)
CORS(app)

# Routes
@app.route('/')
def index():
  """Root endpoint to check if the server is running."""
  return jsonify(message='OpenExpress Python server is running!')

@app.route('/api/save-design', methods=['POST'])
def save_design():
  """Endpoint to receive and process design data from the frontend."""
  print('Received design data to save:', request.json)
  
  # Example of how you might use a JWT secret in a real app
  auth_token = request.headers.get('Authorization')
  if not auth_token or not auth_token.startswith('Bearer '):
    # For demo purposes, we'll log and proceed.
    print('No auth token present, proceeding for demo.')
    # To enforce auth, you would uncomment the following line:
    # return jsonify(error='Authorization token is required.'), 401

  if not request.json or 'title' not in request.json:
    return jsonify(error='Design title is required.'), 400
  
  # In a real app, you would save this data to a database.
  return jsonify(
    message='Design saved successfully!', 
    designId=f'dsn_{int(time.time())}',
    dataReceived=request.json 
  ), 201

@app.route('/api/image-upload', methods=['POST'])
def upload_image():
  """Endpoint to handle image uploads."""
  if 'image_file' not in request.files:
    return jsonify(error='No image file provided.'), 400
  
  file = request.files['image_file']
  
  if file.filename == '':
    return jsonify(error='No selected file.'), 400

  if file:
    # In a real app, you would save the file to a secure location
    # using werkzeug.utils.secure_filename and then store its path.
    print(f"Received image file: {file.filename}")
    print(f"Simulating save for {file.filename}...")
    
    # Return a success response with a placeholder URL
    return jsonify(
        message='Image uploaded successfully!',
        imageUrl=f'https://fake-cdn.com/images/{file.filename}'
    ), 200

# Start the server
if __name__ == '__main__':
  # Get port from environment variable or default to 8080
  port = int(os.environ.get('PORT', 8080))
  app.run(host='0.0.0.0', port=port, debug=True)