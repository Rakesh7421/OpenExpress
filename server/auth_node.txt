// A functional Node.js/Express server for multi-platform authentication.
// To use this:
// 1. Rename this file from 'auth_node.txt' to 'auth.js'.
// 2. In the 'server/' directory, run 'npm install' to get the dependencies from package.json.
// 3. Create a '.env' file in the 'server/' directory.
// 4. Follow the instructions below to get API credentials for each platform.
// 5. Add all credentials to your .env file.
// 6. Run the server with 'node auth.js'.

/*
--------------------------------------------------------------------------------
Setup Instructions & .env Configuration
--------------------------------------------------------------------------------
Create a file named '.env' in this 'server/' directory and add the following,
replacing the placeholder values with your actual credentials.

PORT=3001
SESSION_SECRET=a_very_secret_key_for_sessions_that_is_long_and_random
JWT_SECRET=another_super_secret_key_for_jwt

# Facebook Credentials
... (rest of instructions are the same)
--------------------------------------------------------------------------------
*/

const express = require('express');
const passport = require('passport');
const session = require('express-session');
const cors = require('cors');
const jwt = require('jsonwebtoken');
require('dotenv').config();
const { findOrCreateUser } = require('./database');

// API and Middleware imports
const { verifyToken } = require('./middleware/auth');
const metaApi = require('./api/meta');
const twitterApi = require('./api/twitter');
const linkedinApi = require('./api/linkedin');
const tiktokApi = require('./api/tiktok');

// Passport Strategies
const FacebookStrategy = require('passport-facebook').Strategy;
const TwitterStrategy = require('passport-twitter').Strategy;
const LinkedInStrategy = require('passport-linkedin-oauth2').Strategy;
const TikTokStrategy = require('passport-tiktok-auth').Strategy;

const app = express();
const PORT = process.env.PORT || 3001;

// --- Helper Functions ---
const verifyCallback = (platform) => async (accessToken, refreshToken, profile, done) => {
    console.log(`Successfully authenticated with ${platform}:`);
    console.log(`Profile ID: ${profile.id}, Display Name: ${profile.displayName}`);
    try {
        const user = await findOrCreateUser({
            profile,
            accessToken,
            refreshToken,
        });
        return done(null, user);
    } catch (err) {
        console.error(`Error during findOrCreateUser for ${platform}:`, err);
        return done(err, null);
    }
};

const sendAuthResponse = (res, type, platform) => {
  const message = type === 'success' ? 'Authentication Successful!' : 'Authentication Failed';
  const status = type === 'success' ? 200 : 401;

  res.status(status).send(`
      <script>
        window.opener.postMessage({ type: 'auth-${type}', platform: '${platform}' }, '*');
        window.close();
      </script>
      <h1>${message}</h1>
      <p>You can close this window.</p>
    `);
};

// --- Configuration & Middleware ---
app.use(cors({ origin: '*', credentials: true }));
app.use(session({
  secret: process.env.SESSION_SECRET || 'default_secret',
  resave: false,
  saveUninitialized: true,
  cookie: { secure: false } // Set to true if using HTTPS in production
}));
app.use(passport.initialize());
app.use(passport.session());
app.use(express.json()); // Middleware to parse JSON bodies for API endpoints

// --- Passport General Setup ---
passport.serializeUser((user, done) => done(null, user));
passport.deserializeUser((obj, done) => done(null, obj));


// --- Passport Strategies Setup ---
// ... (Passport strategy setups remain the same) ...
if (process.env.FACEBOOK_APP_ID) {
  passport.use(new FacebookStrategy({
      clientID: process.env.FACEBOOK_APP_ID,
      clientSecret: process.env.FACEBOOK_APP_SECRET,
      callbackURL: `http://localhost:${PORT}/auth/facebook/callback`,
      profileFields: ['id', 'displayName', 'photos', 'email']
    }, verifyCallback('facebook')));
}
if (process.env.TWITTER_CONSUMER_KEY) {
  passport.use(new TwitterStrategy({
    consumerKey: process.env.TWITTER_CONSUMER_KEY,
    consumerSecret: process.env.TWITTER_CONSUMER_SECRET,
    callbackURL: `http://localhost:${PORT}/auth/twitter/callback`,
    includeEmail: true
  }, verifyCallback('twitter')));
}
if (process.env.LINKEDIN_CLIENT_ID) {
  passport.use(new LinkedInStrategy({
    clientID: process.env.LINKEDIN_CLIENT_ID,
    clientSecret: process.env.LINKEDIN_CLIENT_SECRET,
    callbackURL: `http://localhost:${PORT}/auth/linkedin/callback`,
    scope: ['r_emailaddress', 'r_liteprofile'],
  }, verifyCallback('linkedin')));
}
if (process.env.TIKTOK_CLIENT_KEY) {
  passport.use(new TikTokStrategy({
    clientID: process.env.TIKTOK_CLIENT_KEY,
    clientSecret: process.env.TIKTOK_CLIENT_SECRET,
    scope: ['user.info.basic'],
    callbackURL: `http://localhost:${PORT}/auth/tiktok/callback`
  }, verifyCallback('tiktok')));
}


// --- OAuth Authentication Routes ---

app.get('/', (req, res) => res.send('OpenExpress Node.js Authentication Server is running!'));

// Facebook
app.get('/auth/facebook', passport.authenticate('facebook', { scope: ['email'] }));
app.get('/auth/facebook/callback',
  passport.authenticate('facebook', { failureRedirect: '/auth/failed/facebook' }),
  (req, res) => sendAuthResponse(res, 'success', 'facebook')
);
app.get('/auth/failed/facebook', (req, res) => sendAuthResponse(res, 'failure', 'facebook'));

// X (Twitter)
app.get('/auth/twitter', passport.authenticate('twitter'));
app.get('/auth/twitter/callback',
  passport.authenticate('twitter', { failureRedirect: '/auth/failed/twitter' }),
  (req, res) => sendAuthResponse(res, 'success', 'twitter')
);
app.get('/auth/failed/twitter', (req, res) => sendAuthResponse(res, 'failure', 'twitter'));

// LinkedIn
app.get('/auth/linkedin', passport.authenticate('linkedin', { state: 'SOME_STATE' }));
app.get('/auth/linkedin/callback',
  passport.authenticate('linkedin', { failureRedirect: '/auth/failed/linkedin' }),
  (req, res) => sendAuthResponse(res, 'success', 'linkedin')
);
app.get('/auth/failed/linkedin', (req, res) => sendAuthResponse(res, 'failure', 'linkedin'));

// TikTok
app.get('/auth/tiktok', passport.authenticate('tiktok'));
app.get('/auth/tiktok/callback',
  passport.authenticate('tiktok', { failureRedirect: '/auth/failed/tiktok' }),
  (req, res) => sendAuthResponse(res, 'success', 'tiktok')
);
app.get('/auth/failed/tiktok', (req, res) => sendAuthResponse(res, 'failure', 'tiktok'));


// --- Secure API Routes ---
// These routes should be protected by your JWT middleware.

// Meta (Facebook/Instagram) API Routes
app.post('/api/meta/page/video', verifyToken, metaApi.postVideoToPage);
app.post('/api/meta/group/video', verifyToken, metaApi.postVideoToGroup);

// X (Twitter) API Routes
app.post('/api/twitter/tweet', verifyToken, twitterApi.postTweet);

// LinkedIn API Routes
app.post('/api/linkedin/profile/post', verifyToken, linkedinApi.postToProfile);

// TikTok API Routes
app.get('/api/tiktok/user', verifyToken, tiktokApi.getUserInfo);


// --- Start Server ---
app.listen(PORT, () => {
  console.log(`Node.js auth server listening on http://localhost:${PORT}`);
  if (!process.env.SESSION_SECRET) {
      console.warn("WARNING: SESSION_SECRET is not set. Please set it in your .env file for security.");
  }
});